{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ChapterText = exports.StcoAtom = exports.StszAtom = exports.StscAtom = exports.SampleToChunkToken = exports.SttsAtom = exports.TimeToSampleToken = exports.SoundSampleDescriptionV0 = exports.SoundSampleDescriptionVersion = exports.StsdAtom = exports.TrackHeaderAtom = exports.NameAtom = exports.DataAtom = exports.MvhdAtom = exports.MdhdAtom = exports.FixedLengthAtom = exports.mhdr = exports.tkhd = exports.ftyp = exports.ExtendedSize = exports.Header = void 0;\n\nconst Token = require(\"token-types\");\n\nconst FourCC_1 = require(\"../common/FourCC\");\n\nconst initDebug = require(\"debug\");\n\nconst debug = initDebug('music-metadata:parser:MP4:atom');\nexports.Header = {\n  len: 8,\n  get: (buf, off) => {\n    const length = Token.UINT32_BE.get(buf, off);\n    if (length < 0) throw new Error('Invalid atom header length');\n    return {\n      length,\n      name: new Token.StringType(4, 'binary').get(buf, off + 4)\n    };\n  },\n  put: (buf, off, hdr) => {\n    Token.UINT32_BE.put(buf, off, hdr.length);\n    return FourCC_1.FourCcToken.put(buf, off + 4, hdr.name);\n  }\n};\n/**\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap1/qtff1.html#//apple_ref/doc/uid/TP40000939-CH203-38190\r\n */\n\nexports.ExtendedSize = Token.UINT64_BE;\nexports.ftyp = {\n  len: 4,\n  get: (buf, off) => {\n    return {\n      type: new Token.StringType(4, 'ascii').get(buf, off)\n    };\n  }\n};\nexports.tkhd = {\n  len: 4,\n  get: (buf, off) => {\n    return {\n      type: new Token.StringType(4, 'ascii').get(buf, off)\n    };\n  }\n};\n/**\r\n * Token: Movie Header Atom\r\n */\n\nexports.mhdr = {\n  len: 8,\n  get: (buf, off) => {\n    return {\n      version: Token.UINT8.get(buf, off + 0),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      nextItemID: Token.UINT32_BE.get(buf, off + 4)\n    };\n  }\n};\n/**\r\n * Base class for 'fixed' length atoms.\r\n * In some cases these atoms are longer then the sum of the described fields.\r\n * Issue: https://github.com/Borewit/music-metadata/issues/120\r\n */\n\nclass FixedLengthAtom {\n  /**\r\n   *\r\n   * @param {number} len Length as specified in the size field\r\n   * @param {number} expLen Total length of sum of specified fields in the standard\r\n   */\n  constructor(len, expLen, atomId) {\n    this.len = len;\n\n    if (len < expLen) {\n      throw new Error(`Atom ${atomId} expected to be ${expLen}, but specifies ${len} bytes long.`);\n    } else if (len > expLen) {\n      debug(`Warning: atom ${atomId} expected to be ${expLen}, but was actually ${len} bytes long.`);\n    }\n  }\n\n}\n\nexports.FixedLengthAtom = FixedLengthAtom;\n/**\r\n * Timestamp stored in seconds since Mac Epoch (1 January 1904)\r\n */\n\nconst SecondsSinceMacEpoch = {\n  len: 4,\n  get: (buf, off) => {\n    const secondsSinceUnixEpoch = Token.UINT32_BE.get(buf, off) - 2082844800;\n    return new Date(secondsSinceUnixEpoch * 1000);\n  }\n};\n/**\r\n * Token: Media Header Atom\r\n * Ref:\r\n *   https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-SW34\r\n *   https://wiki.multimedia.cx/index.php/QuickTime_container#mdhd\r\n */\n\nclass MdhdAtom extends FixedLengthAtom {\n  constructor(len) {\n    super(len, 24, 'mdhd');\n    this.len = len;\n  }\n\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off + 0),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\n      modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\n      timeScale: Token.UINT32_BE.get(buf, off + 12),\n      duration: Token.UINT32_BE.get(buf, off + 16),\n      language: Token.UINT16_BE.get(buf, off + 20),\n      quality: Token.UINT16_BE.get(buf, off + 22)\n    };\n  }\n\n}\n\nexports.MdhdAtom = MdhdAtom;\n/**\r\n * Token: Movie Header Atom\r\n */\n\nclass MvhdAtom extends FixedLengthAtom {\n  constructor(len) {\n    super(len, 100, 'mvhd');\n    this.len = len;\n  }\n\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\n      modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\n      timeScale: Token.UINT32_BE.get(buf, off + 12),\n      duration: Token.UINT32_BE.get(buf, off + 16),\n      preferredRate: Token.UINT32_BE.get(buf, off + 20),\n      preferredVolume: Token.UINT16_BE.get(buf, off + 24),\n      // ignore reserver: 10 bytes\n      // ignore matrix structure: 36 bytes\n      previewTime: Token.UINT32_BE.get(buf, off + 72),\n      previewDuration: Token.UINT32_BE.get(buf, off + 76),\n      posterTime: Token.UINT32_BE.get(buf, off + 80),\n      selectionTime: Token.UINT32_BE.get(buf, off + 84),\n      selectionDuration: Token.UINT32_BE.get(buf, off + 88),\n      currentTime: Token.UINT32_BE.get(buf, off + 92),\n      nextTrackID: Token.UINT32_BE.get(buf, off + 96)\n    };\n  }\n\n}\n\nexports.MvhdAtom = MvhdAtom;\n/**\r\n * Data Atom Structure\r\n */\n\nclass DataAtom {\n  constructor(len) {\n    this.len = len;\n  }\n\n  get(buf, off) {\n    return {\n      type: {\n        set: Token.UINT8.get(buf, off + 0),\n        type: Token.UINT24_BE.get(buf, off + 1)\n      },\n      locale: Token.UINT24_BE.get(buf, off + 4),\n      value: new Token.BufferType(this.len - 8).get(buf, off + 8)\n    };\n  }\n\n}\n\nexports.DataAtom = DataAtom;\n/**\r\n * Data Atom Structure\r\n * Ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/Metadata/Metadata.html#//apple_ref/doc/uid/TP40000939-CH1-SW31\r\n */\n\nclass NameAtom {\n  constructor(len) {\n    this.len = len;\n  }\n\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      name: new Token.StringType(this.len - 4, 'utf-8').get(buf, off + 4)\n    };\n  }\n\n}\n\nexports.NameAtom = NameAtom;\n/**\r\n * Track Header Atoms structure\r\n * Ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25550\r\n */\n\nclass TrackHeaderAtom {\n  constructor(len) {\n    this.len = len;\n  }\n\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\n      modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\n      trackId: Token.UINT32_BE.get(buf, off + 12),\n      // reserved 4 bytes\n      duration: Token.UINT32_BE.get(buf, off + 20),\n      layer: Token.UINT16_BE.get(buf, off + 24),\n      alternateGroup: Token.UINT16_BE.get(buf, off + 26),\n      volume: Token.UINT16_BE.get(buf, off + 28) // ToDo: fixed point\n      // ToDo: add remaining fields\n\n    };\n  }\n\n}\n\nexports.TrackHeaderAtom = TrackHeaderAtom;\n/**\r\n * Atom: Sample Description Atom ('stsd')\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\r\n */\n\nconst stsdHeader = {\n  len: 8,\n  get: (buf, off) => {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      numberOfEntries: Token.UINT32_BE.get(buf, off + 4)\n    };\n  }\n};\n/**\r\n * Atom: Sample Description Atom ('stsd')\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\r\n */\n\nclass SampleDescriptionTable {\n  constructor(len) {\n    this.len = len;\n  }\n\n  get(buf, off) {\n    return {\n      dataFormat: FourCC_1.FourCcToken.get(buf, off),\n      dataReferenceIndex: Token.UINT16_BE.get(buf, off + 10),\n      description: new Token.BufferType(this.len - 12).get(buf, off + 12)\n    };\n  }\n\n}\n/**\r\n * Atom: Sample-description Atom ('stsd')\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\r\n */\n\n\nclass StsdAtom {\n  constructor(len) {\n    this.len = len;\n  }\n\n  get(buf, off) {\n    const header = stsdHeader.get(buf, off);\n    off += stsdHeader.len;\n    const table = [];\n\n    for (let n = 0; n < header.numberOfEntries; ++n) {\n      const size = Token.UINT32_BE.get(buf, off); // Sample description size\n\n      off += Token.UINT32_BE.len;\n      table.push(new SampleDescriptionTable(size).get(buf, off));\n      off += size;\n    }\n\n    return {\n      header,\n      table\n    };\n  }\n\n}\n\nexports.StsdAtom = StsdAtom;\n/**\r\n * Common Sound Sample Description (version & revision)\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap3/qtff3.html#//apple_ref/doc/uid/TP40000939-CH205-57317\r\n */\n\nexports.SoundSampleDescriptionVersion = {\n  len: 8,\n\n  get(buf, off) {\n    return {\n      version: Token.INT16_BE.get(buf, off),\n      revision: Token.INT16_BE.get(buf, off + 2),\n      vendor: Token.INT32_BE.get(buf, off + 4)\n    };\n  }\n\n};\n/**\r\n * Sound Sample Description (Version 0)\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap3/qtff3.html#//apple_ref/doc/uid/TP40000939-CH205-130736\r\n */\n\nexports.SoundSampleDescriptionV0 = {\n  len: 12,\n\n  get(buf, off) {\n    return {\n      numAudioChannels: Token.INT16_BE.get(buf, off + 0),\n      sampleSize: Token.INT16_BE.get(buf, off + 2),\n      compressionId: Token.INT16_BE.get(buf, off + 4),\n      packetSize: Token.INT16_BE.get(buf, off + 6),\n      sampleRate: Token.UINT16_BE.get(buf, off + 8) + Token.UINT16_BE.get(buf, off + 10) / 10000\n    };\n  }\n\n};\n\nclass SimpleTableAtom {\n  constructor(len, token) {\n    this.len = len;\n    this.token = token;\n  }\n\n  get(buf, off) {\n    const nrOfEntries = Token.INT32_BE.get(buf, off + 4);\n    return {\n      version: Token.INT8.get(buf, off + 0),\n      flags: Token.INT24_BE.get(buf, off + 1),\n      numberOfEntries: nrOfEntries,\n      entries: readTokenTable(buf, this.token, off + 8, this.len - 8, nrOfEntries)\n    };\n  }\n\n}\n\nexports.TimeToSampleToken = {\n  len: 8,\n\n  get(buf, off) {\n    return {\n      count: Token.INT32_BE.get(buf, off + 0),\n      duration: Token.INT32_BE.get(buf, off + 4)\n    };\n  }\n\n};\n/**\r\n * Time-to-sample('stts') atom.\r\n * Store duration information for a media’s samples.\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25696\r\n */\n\nclass SttsAtom extends SimpleTableAtom {\n  constructor(len) {\n    super(len, exports.TimeToSampleToken);\n    this.len = len;\n  }\n\n}\n\nexports.SttsAtom = SttsAtom;\nexports.SampleToChunkToken = {\n  len: 12,\n\n  get(buf, off) {\n    return {\n      firstChunk: Token.INT32_BE.get(buf, off),\n      samplesPerChunk: Token.INT32_BE.get(buf, off + 4),\n      sampleDescriptionId: Token.INT32_BE.get(buf, off + 8)\n    };\n  }\n\n};\n/**\r\n * Sample-to-Chunk ('stsc') atom interface\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25706\r\n */\n\nclass StscAtom extends SimpleTableAtom {\n  constructor(len) {\n    super(len, exports.SampleToChunkToken);\n    this.len = len;\n  }\n\n}\n\nexports.StscAtom = StscAtom;\n/**\r\n * Sample-size ('stsz') atom\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25710\r\n */\n\nclass StszAtom {\n  constructor(len) {\n    this.len = len;\n  }\n\n  get(buf, off) {\n    const nrOfEntries = Token.INT32_BE.get(buf, off + 8);\n    return {\n      version: Token.INT8.get(buf, off),\n      flags: Token.INT24_BE.get(buf, off + 1),\n      sampleSize: Token.INT32_BE.get(buf, off + 4),\n      numberOfEntries: nrOfEntries,\n      entries: readTokenTable(buf, Token.INT32_BE, off + 12, this.len - 12, nrOfEntries)\n    };\n  }\n\n}\n\nexports.StszAtom = StszAtom;\n/**\r\n * Chunk offset atom, 'stco'\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25715\r\n */\n\nclass StcoAtom extends SimpleTableAtom {\n  constructor(len) {\n    super(len, Token.INT32_BE);\n    this.len = len;\n  }\n\n}\n\nexports.StcoAtom = StcoAtom;\n/**\r\n * Token used to decode text-track from 'mdat' atom (raw data stream)\r\n */\n\nclass ChapterText {\n  constructor(len) {\n    this.len = len;\n  }\n\n  get(buf, off) {\n    const titleLen = Token.INT16_BE.get(buf, off + 0);\n    const str = new Token.StringType(titleLen, 'utf-8');\n    return str.get(buf, off + 2);\n  }\n\n}\n\nexports.ChapterText = ChapterText;\n\nfunction readTokenTable(buf, token, off, remainingLen, numberOfEntries) {\n  debug(`remainingLen=${remainingLen}, numberOfEntries=${numberOfEntries} * token-len=${token.len}`);\n  if (remainingLen === 0) return [];\n  if (remainingLen !== numberOfEntries * token.len) throw new Error('mismatch number-of-entries with remaining atom-length');\n  const entries = []; // parse offset-table\n\n  for (let n = 0; n < numberOfEntries; ++n) {\n    entries.push(token.get(buf, off));\n    off += token.len;\n  }\n\n  return entries;\n}","map":{"version":3,"sources":["/Users/johnobrien/Desktop/JOB_Developer/client/node_modules/music-metadata/lib/mp4/AtomToken.js"],"names":["Object","defineProperty","exports","value","ChapterText","StcoAtom","StszAtom","StscAtom","SampleToChunkToken","SttsAtom","TimeToSampleToken","SoundSampleDescriptionV0","SoundSampleDescriptionVersion","StsdAtom","TrackHeaderAtom","NameAtom","DataAtom","MvhdAtom","MdhdAtom","FixedLengthAtom","mhdr","tkhd","ftyp","ExtendedSize","Header","Token","require","FourCC_1","initDebug","debug","len","get","buf","off","length","UINT32_BE","Error","name","StringType","put","hdr","FourCcToken","UINT64_BE","type","version","UINT8","flags","UINT24_BE","nextItemID","constructor","expLen","atomId","SecondsSinceMacEpoch","secondsSinceUnixEpoch","Date","creationTime","modificationTime","timeScale","duration","language","UINT16_BE","quality","preferredRate","preferredVolume","previewTime","previewDuration","posterTime","selectionTime","selectionDuration","currentTime","nextTrackID","set","locale","BufferType","trackId","layer","alternateGroup","volume","stsdHeader","numberOfEntries","SampleDescriptionTable","dataFormat","dataReferenceIndex","description","header","table","n","size","push","INT16_BE","revision","vendor","INT32_BE","numAudioChannels","sampleSize","compressionId","packetSize","sampleRate","SimpleTableAtom","token","nrOfEntries","INT8","INT24_BE","entries","readTokenTable","count","firstChunk","samplesPerChunk","sampleDescriptionId","titleLen","str","remainingLen"],"mappings":"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","sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.ChapterText = exports.StcoAtom = exports.StszAtom = exports.StscAtom = exports.SampleToChunkToken = exports.SttsAtom = exports.TimeToSampleToken = exports.SoundSampleDescriptionV0 = exports.SoundSampleDescriptionVersion = exports.StsdAtom = exports.TrackHeaderAtom = exports.NameAtom = exports.DataAtom = exports.MvhdAtom = exports.MdhdAtom = exports.FixedLengthAtom = exports.mhdr = exports.tkhd = exports.ftyp = exports.ExtendedSize = exports.Header = void 0;\r\nconst Token = require(\"token-types\");\r\nconst FourCC_1 = require(\"../common/FourCC\");\r\nconst initDebug = require(\"debug\");\r\nconst debug = initDebug('music-metadata:parser:MP4:atom');\r\nexports.Header = {\r\n    len: 8,\r\n    get: (buf, off) => {\r\n        const length = Token.UINT32_BE.get(buf, off);\r\n        if (length < 0)\r\n            throw new Error('Invalid atom header length');\r\n        return {\r\n            length,\r\n            name: new Token.StringType(4, 'binary').get(buf, off + 4)\r\n        };\r\n    },\r\n    put: (buf, off, hdr) => {\r\n        Token.UINT32_BE.put(buf, off, hdr.length);\r\n        return FourCC_1.FourCcToken.put(buf, off + 4, hdr.name);\r\n    }\r\n};\r\n/**\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap1/qtff1.html#//apple_ref/doc/uid/TP40000939-CH203-38190\r\n */\r\nexports.ExtendedSize = Token.UINT64_BE;\r\nexports.ftyp = {\r\n    len: 4,\r\n    get: (buf, off) => {\r\n        return {\r\n            type: new Token.StringType(4, 'ascii').get(buf, off)\r\n        };\r\n    }\r\n};\r\nexports.tkhd = {\r\n    len: 4,\r\n    get: (buf, off) => {\r\n        return {\r\n            type: new Token.StringType(4, 'ascii').get(buf, off)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Token: Movie Header Atom\r\n */\r\nexports.mhdr = {\r\n    len: 8,\r\n    get: (buf, off) => {\r\n        return {\r\n            version: Token.UINT8.get(buf, off + 0),\r\n            flags: Token.UINT24_BE.get(buf, off + 1),\r\n            nextItemID: Token.UINT32_BE.get(buf, off + 4)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Base class for 'fixed' length atoms.\r\n * In some cases these atoms are longer then the sum of the described fields.\r\n * Issue: https://github.com/Borewit/music-metadata/issues/120\r\n */\r\nclass FixedLengthAtom {\r\n    /**\r\n     *\r\n     * @param {number} len Length as specified in the size field\r\n     * @param {number} expLen Total length of sum of specified fields in the standard\r\n     */\r\n    constructor(len, expLen, atomId) {\r\n        this.len = len;\r\n        if (len < expLen) {\r\n            throw new Error(`Atom ${atomId} expected to be ${expLen}, but specifies ${len} bytes long.`);\r\n        }\r\n        else if (len > expLen) {\r\n            debug(`Warning: atom ${atomId} expected to be ${expLen}, but was actually ${len} bytes long.`);\r\n        }\r\n    }\r\n}\r\nexports.FixedLengthAtom = FixedLengthAtom;\r\n/**\r\n * Timestamp stored in seconds since Mac Epoch (1 January 1904)\r\n */\r\nconst SecondsSinceMacEpoch = {\r\n    len: 4,\r\n    get: (buf, off) => {\r\n        const secondsSinceUnixEpoch = Token.UINT32_BE.get(buf, off) - 2082844800;\r\n        return new Date(secondsSinceUnixEpoch * 1000);\r\n    }\r\n};\r\n/**\r\n * Token: Media Header Atom\r\n * Ref:\r\n *   https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-SW34\r\n *   https://wiki.multimedia.cx/index.php/QuickTime_container#mdhd\r\n */\r\nclass MdhdAtom extends FixedLengthAtom {\r\n    constructor(len) {\r\n        super(len, 24, 'mdhd');\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        return {\r\n            version: Token.UINT8.get(buf, off + 0),\r\n            flags: Token.UINT24_BE.get(buf, off + 1),\r\n            creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\r\n            modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\r\n            timeScale: Token.UINT32_BE.get(buf, off + 12),\r\n            duration: Token.UINT32_BE.get(buf, off + 16),\r\n            language: Token.UINT16_BE.get(buf, off + 20),\r\n            quality: Token.UINT16_BE.get(buf, off + 22)\r\n        };\r\n    }\r\n}\r\nexports.MdhdAtom = MdhdAtom;\r\n/**\r\n * Token: Movie Header Atom\r\n */\r\nclass MvhdAtom extends FixedLengthAtom {\r\n    constructor(len) {\r\n        super(len, 100, 'mvhd');\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        return {\r\n            version: Token.UINT8.get(buf, off),\r\n            flags: Token.UINT24_BE.get(buf, off + 1),\r\n            creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\r\n            modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\r\n            timeScale: Token.UINT32_BE.get(buf, off + 12),\r\n            duration: Token.UINT32_BE.get(buf, off + 16),\r\n            preferredRate: Token.UINT32_BE.get(buf, off + 20),\r\n            preferredVolume: Token.UINT16_BE.get(buf, off + 24),\r\n            // ignore reserver: 10 bytes\r\n            // ignore matrix structure: 36 bytes\r\n            previewTime: Token.UINT32_BE.get(buf, off + 72),\r\n            previewDuration: Token.UINT32_BE.get(buf, off + 76),\r\n            posterTime: Token.UINT32_BE.get(buf, off + 80),\r\n            selectionTime: Token.UINT32_BE.get(buf, off + 84),\r\n            selectionDuration: Token.UINT32_BE.get(buf, off + 88),\r\n            currentTime: Token.UINT32_BE.get(buf, off + 92),\r\n            nextTrackID: Token.UINT32_BE.get(buf, off + 96)\r\n        };\r\n    }\r\n}\r\nexports.MvhdAtom = MvhdAtom;\r\n/**\r\n * Data Atom Structure\r\n */\r\nclass DataAtom {\r\n    constructor(len) {\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        return {\r\n            type: {\r\n                set: Token.UINT8.get(buf, off + 0),\r\n                type: Token.UINT24_BE.get(buf, off + 1)\r\n            },\r\n            locale: Token.UINT24_BE.get(buf, off + 4),\r\n            value: new Token.BufferType(this.len - 8).get(buf, off + 8)\r\n        };\r\n    }\r\n}\r\nexports.DataAtom = DataAtom;\r\n/**\r\n * Data Atom Structure\r\n * Ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/Metadata/Metadata.html#//apple_ref/doc/uid/TP40000939-CH1-SW31\r\n */\r\nclass NameAtom {\r\n    constructor(len) {\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        return {\r\n            version: Token.UINT8.get(buf, off),\r\n            flags: Token.UINT24_BE.get(buf, off + 1),\r\n            name: new Token.StringType(this.len - 4, 'utf-8').get(buf, off + 4)\r\n        };\r\n    }\r\n}\r\nexports.NameAtom = NameAtom;\r\n/**\r\n * Track Header Atoms structure\r\n * Ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25550\r\n */\r\nclass TrackHeaderAtom {\r\n    constructor(len) {\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        return {\r\n            version: Token.UINT8.get(buf, off),\r\n            flags: Token.UINT24_BE.get(buf, off + 1),\r\n            creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\r\n            modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\r\n            trackId: Token.UINT32_BE.get(buf, off + 12),\r\n            // reserved 4 bytes\r\n            duration: Token.UINT32_BE.get(buf, off + 20),\r\n            layer: Token.UINT16_BE.get(buf, off + 24),\r\n            alternateGroup: Token.UINT16_BE.get(buf, off + 26),\r\n            volume: Token.UINT16_BE.get(buf, off + 28) // ToDo: fixed point\r\n            // ToDo: add remaining fields\r\n        };\r\n    }\r\n}\r\nexports.TrackHeaderAtom = TrackHeaderAtom;\r\n/**\r\n * Atom: Sample Description Atom ('stsd')\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\r\n */\r\nconst stsdHeader = {\r\n    len: 8,\r\n    get: (buf, off) => {\r\n        return {\r\n            version: Token.UINT8.get(buf, off),\r\n            flags: Token.UINT24_BE.get(buf, off + 1),\r\n            numberOfEntries: Token.UINT32_BE.get(buf, off + 4)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Atom: Sample Description Atom ('stsd')\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\r\n */\r\nclass SampleDescriptionTable {\r\n    constructor(len) {\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        return {\r\n            dataFormat: FourCC_1.FourCcToken.get(buf, off),\r\n            dataReferenceIndex: Token.UINT16_BE.get(buf, off + 10),\r\n            description: new Token.BufferType(this.len - 12).get(buf, off + 12)\r\n        };\r\n    }\r\n}\r\n/**\r\n * Atom: Sample-description Atom ('stsd')\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\r\n */\r\nclass StsdAtom {\r\n    constructor(len) {\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        const header = stsdHeader.get(buf, off);\r\n        off += stsdHeader.len;\r\n        const table = [];\r\n        for (let n = 0; n < header.numberOfEntries; ++n) {\r\n            const size = Token.UINT32_BE.get(buf, off); // Sample description size\r\n            off += Token.UINT32_BE.len;\r\n            table.push(new SampleDescriptionTable(size).get(buf, off));\r\n            off += size;\r\n        }\r\n        return {\r\n            header,\r\n            table\r\n        };\r\n    }\r\n}\r\nexports.StsdAtom = StsdAtom;\r\n/**\r\n * Common Sound Sample Description (version & revision)\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap3/qtff3.html#//apple_ref/doc/uid/TP40000939-CH205-57317\r\n */\r\nexports.SoundSampleDescriptionVersion = {\r\n    len: 8,\r\n    get(buf, off) {\r\n        return {\r\n            version: Token.INT16_BE.get(buf, off),\r\n            revision: Token.INT16_BE.get(buf, off + 2),\r\n            vendor: Token.INT32_BE.get(buf, off + 4)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Sound Sample Description (Version 0)\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap3/qtff3.html#//apple_ref/doc/uid/TP40000939-CH205-130736\r\n */\r\nexports.SoundSampleDescriptionV0 = {\r\n    len: 12,\r\n    get(buf, off) {\r\n        return {\r\n            numAudioChannels: Token.INT16_BE.get(buf, off + 0),\r\n            sampleSize: Token.INT16_BE.get(buf, off + 2),\r\n            compressionId: Token.INT16_BE.get(buf, off + 4),\r\n            packetSize: Token.INT16_BE.get(buf, off + 6),\r\n            sampleRate: Token.UINT16_BE.get(buf, off + 8) + Token.UINT16_BE.get(buf, off + 10) / 10000\r\n        };\r\n    }\r\n};\r\nclass SimpleTableAtom {\r\n    constructor(len, token) {\r\n        this.len = len;\r\n        this.token = token;\r\n    }\r\n    get(buf, off) {\r\n        const nrOfEntries = Token.INT32_BE.get(buf, off + 4);\r\n        return {\r\n            version: Token.INT8.get(buf, off + 0),\r\n            flags: Token.INT24_BE.get(buf, off + 1),\r\n            numberOfEntries: nrOfEntries,\r\n            entries: readTokenTable(buf, this.token, off + 8, this.len - 8, nrOfEntries)\r\n        };\r\n    }\r\n}\r\nexports.TimeToSampleToken = {\r\n    len: 8,\r\n    get(buf, off) {\r\n        return {\r\n            count: Token.INT32_BE.get(buf, off + 0),\r\n            duration: Token.INT32_BE.get(buf, off + 4)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Time-to-sample('stts') atom.\r\n * Store duration information for a media’s samples.\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25696\r\n */\r\nclass SttsAtom extends SimpleTableAtom {\r\n    constructor(len) {\r\n        super(len, exports.TimeToSampleToken);\r\n        this.len = len;\r\n    }\r\n}\r\nexports.SttsAtom = SttsAtom;\r\nexports.SampleToChunkToken = {\r\n    len: 12,\r\n    get(buf, off) {\r\n        return {\r\n            firstChunk: Token.INT32_BE.get(buf, off),\r\n            samplesPerChunk: Token.INT32_BE.get(buf, off + 4),\r\n            sampleDescriptionId: Token.INT32_BE.get(buf, off + 8)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Sample-to-Chunk ('stsc') atom interface\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25706\r\n */\r\nclass StscAtom extends SimpleTableAtom {\r\n    constructor(len) {\r\n        super(len, exports.SampleToChunkToken);\r\n        this.len = len;\r\n    }\r\n}\r\nexports.StscAtom = StscAtom;\r\n/**\r\n * Sample-size ('stsz') atom\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25710\r\n */\r\nclass StszAtom {\r\n    constructor(len) {\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        const nrOfEntries = Token.INT32_BE.get(buf, off + 8);\r\n        return {\r\n            version: Token.INT8.get(buf, off),\r\n            flags: Token.INT24_BE.get(buf, off + 1),\r\n            sampleSize: Token.INT32_BE.get(buf, off + 4),\r\n            numberOfEntries: nrOfEntries,\r\n            entries: readTokenTable(buf, Token.INT32_BE, off + 12, this.len - 12, nrOfEntries)\r\n        };\r\n    }\r\n}\r\nexports.StszAtom = StszAtom;\r\n/**\r\n * Chunk offset atom, 'stco'\r\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25715\r\n */\r\nclass StcoAtom extends SimpleTableAtom {\r\n    constructor(len) {\r\n        super(len, Token.INT32_BE);\r\n        this.len = len;\r\n    }\r\n}\r\nexports.StcoAtom = StcoAtom;\r\n/**\r\n * Token used to decode text-track from 'mdat' atom (raw data stream)\r\n */\r\nclass ChapterText {\r\n    constructor(len) {\r\n        this.len = len;\r\n    }\r\n    get(buf, off) {\r\n        const titleLen = Token.INT16_BE.get(buf, off + 0);\r\n        const str = new Token.StringType(titleLen, 'utf-8');\r\n        return str.get(buf, off + 2);\r\n    }\r\n}\r\nexports.ChapterText = ChapterText;\r\nfunction readTokenTable(buf, token, off, remainingLen, numberOfEntries) {\r\n    debug(`remainingLen=${remainingLen}, numberOfEntries=${numberOfEntries} * token-len=${token.len}`);\r\n    if (remainingLen === 0)\r\n        return [];\r\n    if (remainingLen !== numberOfEntries * token.len)\r\n        throw new Error('mismatch number-of-entries with remaining atom-length');\r\n    const entries = [];\r\n    // parse offset-table\r\n    for (let n = 0; n < numberOfEntries; ++n) {\r\n        entries.push(token.get(buf, off));\r\n        off += token.len;\r\n    }\r\n    return entries;\r\n}\r\n"]},"metadata":{},"sourceType":"script"}